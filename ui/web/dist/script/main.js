import Canvas, { AltBrush, BrushRadius, MainBrush } from "./canvas.js";
import { AsyncTry } from "./module/errors/try.js";
import jsxmm from "./module/jsxmm/element.js";
import "./wasm/wasm_exec.js";
async function main() {
    await start_go();
    const Root = root();
    const response = await fetch(new URL("nn/model/digits.json", Root));
    if (!response.ok) {
        throw new Error("retrieve neural network");
    }
    const neural_network = await response.text();
    go(load)(neural_network);
    const canvas = document.querySelector("#canvas");
    if (canvas === null) {
        throw new Error("there must be a #canvas element");
    }
    const draw = new Canvas(canvas, go(classify));
    const undo_input = document.querySelector("#undo");
    if (undo_input !== null) {
        undo_input.addEventListener("click", Canvas.prototype.Undo.bind(draw));
    }
    const redo_input = document.querySelector("#redo");
    if (redo_input !== null) {
        redo_input.addEventListener("click", Canvas.prototype.Redo.bind(draw));
    }
    const brush_input = document.querySelector("#brush");
    if (brush_input !== null) {
        brush_input.addEventListener("click", (evt) => {
            if (evt.target !== evt.currentTarget) {
                return;
            }
            if (brush_input.classList.contains("alt")) {
                draw.SetBrush(MainBrush);
            }
            else {
                draw.SetBrush(AltBrush);
            }
            brush_input.classList.toggle("alt");
        });
    }
    const radius_input = document.querySelector("#radius");
    if (radius_input !== null) {
        jsxmm.Assign(radius_input, {
            min: ".5", step: ".5", max: "3",
            value: "1",
        });
        radius_input.addEventListener("click", (evt) => {
            let radius = +radius_input.value;
            if (Number.isNaN(radius)) {
                radius = BrushRadius;
            }
            draw.SetRadius(radius);
        });
    }
    const clear_input = document.querySelector("#clear");
    if (clear_input !== null) {
        clear_input.addEventListener("click", Canvas.prototype.Reset.bind(draw));
    }
    const result_input = document.querySelector("#result");
    if (result_input === null) {
        throw new Error("there must be a #result element");
    }
    const outputs = draw.Outputs();
    for (let i = 0; i < outputs.length; i++) {
        result_input.append(jsxmm.Element("label", { className: "result", textContent: `${i}` }, outputs[i]));
    }
}
function root() {
    if (location.origin === "https://alan-b-lima.github.io") {
        return "https://alan-b-lima.github.io/nn-digits/";
    }
    return location.origin;
}
async function start_go() {
    const [response, error] = await AsyncTry(() => fetch("./script/wasm/main.wasm"));
    if (error !== null) {
        throw new Error("Go Wasm module not found");
    }
    const go = new Go();
    const result = await WebAssembly.instantiateStreaming(response, go.importObject);
    go.run(result.instance);
}
function go(func) {
    return function (...args) {
        const ret = func(...args);
        if (ret instanceof Error) {
            throw ret;
        }
        return ret;
    };
}
window.addEventListener("DOMContentLoaded", main, { once: true });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sTUFBTSxFQUFFLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFDdEUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ2pELE9BQU8sS0FBSyxNQUFNLDJCQUEyQixDQUFBO0FBQzdDLE9BQU8scUJBQXFCLENBQUE7QUFLNUIsS0FBSyxVQUFVLElBQUk7SUFDZixNQUFNLFFBQVEsRUFBRSxDQUFBO0lBRWhCLE1BQU0sSUFBSSxHQUFHLElBQUksRUFBRSxDQUFBO0lBRW5CLE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxDQUFDLENBQUE7SUFDbkUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQTtJQUM5QyxDQUFDO0lBRUQsTUFBTSxjQUFjLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDNUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0lBRXhCLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQW9CLFNBQVMsQ0FBQyxDQUFBO0lBQ25FLElBQUksTUFBTSxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQTtJQUN0RCxDQUFDO0lBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO0lBRTdDLE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQWMsT0FBTyxDQUFDLENB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